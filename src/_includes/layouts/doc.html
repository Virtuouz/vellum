{% layout "layouts/base.html" %}

{% assign primaryCollectionTag = tags | first %}
 {% assign docCollections = docCollections | reject: "key", "changelog" %}
{% for collection in docCollections %}
 {% if collection.key == primaryCollectionTag %} 

{% assign primaryCollection = collection %}
 {% capture primaryCollectionName %}
 {% if collection.name and collection.name != "" %}
 {{ collection.name }}
  {% else %}
{{ collection.key }}
 {% endif %}
 {% endcapture %} 
 {% endif %} 
{% endfor %}


{% for tag in tags %}
{% if tag == "changelog" %}{% continue %}
{% endif %}
{% assign navPages = navPages | concat: collections[tag] %}
{% endfor %}
{% assign navPages = navPages | eleventyNavigation | uniq %}

{% comment %}
  --- PREVIOUS/NEXT NAVIGATION LOGIC ---
  1. Flatten the entire nested navigation tree into a parsable string.
  2. Split the string into an array of flat navigation items.
  3. Loop through the flat array to find the index of the current page.
  4. Get the items at the previous (index - 1) and next (index + 1) positions.
{% endcomment %}
{%- capture flat_nav_data_str -%}
  {%- for entry in navPages -%}
    {%- render "partials/get-flat-nav-data.html", entry: entry, parentTitle: "" -%}
  {%- endfor -%}
{%- endcapture -%}

{%- assign flatNavItems = flat_nav_data_str | split: '|||' | where_exp: "item", "item != ''" -%}

{%- for item_str in flatNavItems -%}
  {%- assign item_parts = item_str | split: ';' -%}
  {%- assign item_url = item_parts[0] -%}
  {%- if item_url == page.url -%}
    {%- assign currentIndex = forloop.index0 -%}
  {%- endif -%}
{%- endfor -%}

{%- if currentIndex != nil -%}
  {%- assign prevIndex = currentIndex | minus: 1 -%}
  {%- assign nextIndex = currentIndex | plus: 1 -%}

  {%- if prevIndex >= 0 -%}
    {%- assign prev_item_parts = flatNavItems[prevIndex] | split: ';' -%}
    {%- assign prev_url = prev_item_parts[0] -%}
    {%- assign prev_title = prev_item_parts[1] -%}
    {%- assign prev_parent = prev_item_parts[2] -%}
  {%- endif -%}

  {%- if nextIndex < flatNavItems.size -%}
    {%- assign next_item_parts = flatNavItems[nextIndex] | split: ';' -%}
    {%- assign next_url = next_item_parts[0] -%}
    {%- assign next_title = next_item_parts[1] -%}
    {%- assign next_parent = next_item_parts[2] -%}
  {%- endif -%}
{%- endif -%}


{% block content %}

<!-- Bookshop component for page content -->
{% capture bookshopContent %}
  {% bookshop_include "doc" editorial_blocks: editorial_blocks %}
{% endcapture %}

{% assign bookshopTOC = bookshopContent | toc %}
{% assign contentTOC = content | toc  %}

<dialog id="modal-search" class="fixed top-0 z-[920] h-full w-full overflow-scroll p-4 opacity-0 open:bg-surface open:bg-opacity-80 open:backdrop-blur-lg sm:p-10">
  <div class="flex flex-col gap-10">
    <button
      class="sticky top-0 self-end font-bold text-textColor-primary opacity-60 z-[930]"
      _="
        on click
        set modal to #modal-search
        transition #modal-search opacity to 0 over 0.1s settle then
        modal.close()
        ">
      {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: "x-mark" iconType: "solid" iconSize: 'large' roundedBorder: false themeColor: true %}
    </button>
    <div class="self-center w-full max-w-[90%] {% if resource._bookshop_name != "generic/videoEmbed" %}flex justify-center{% endif %}">
<div id="search" class="w-full md:max-w-[80%]"></div>
    </div>
  </div>
</dialog>
<div class=" relative flex min-h-screen text-textColor-primary bg-body font-inter ">
 
  <!-- Left Sidebar Navigation -->
  <aside id="navigation-bar" class="transition-all duration-300 origin-right fixed invisible scale-x-0 z-20 right-0 lg:visible lg:scale-x-100 lg:sticky order-4 lg:order-1  lg:flex lg:flex-col w-72 h-screen border-r border-borderColor-primary p-4  top-0 bg-surface overflow-y-auto"
  _="
          on click from elsewhere
          add .scale-x-0 to #navigation-bar
          add .invisible to #navigation-bar
          remove .scale-x-100 from #navigation-bar
        end
  "
  >
    <!-- Search and Collection Selection Section -->
    <div class="mt-4 justify-between flex flex-col gap-2 pb-4 mb-4 border-b border-borderColor-primary">
      <!-- Search Bar -->
      <button class="hidden lg:block relative bg-interactive-hover rounded-md"
        _="
      on click
      set modal to #modal-search
      modal.show()
      transition #modal-search opacity to 1 over 0.2s
      "
      >
        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </span>
        <div
        class="flex w-full justify-between text-left pl-10 pr-4 py-2 bg-transparent border border-transparent focus:border-accent-secondary rounded-md focus:outline-none focus:ring-1 focus:ring-accent-secondary text-sm transition-colors duration-200"
      >
    <p class="opacity-40">Search</p> <div class="opacity-80"><span class="kbd">ctrl</span>+<span class="kbd">k</span></div></div>
      </button>      
      <div class="lg:hidden self-end flex gap-4 items-center">
        <!-- Theme Toggle -->
          <div class=" flex justify-between">
      <button
        aria-label="Color theme toggle"
        id="dark-toggle-mobile"
        class="flex gap-2 p-1 items-center text-sm opacity-75 border border-textColor-primary rounded-full"
        aria-label="Toggle color theme"
      >
        <div id="sun-icon-mobile">
          {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: "sun" iconType: "solid" iconSize: 'xxsmall' roundedBorder: false, themeColor: true %}
        </div>
        <div id="moon-icon-mobile">
          {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: "moon" iconType: "solid" iconSize: 'xxsmall' roundedBorder: false, themeColor: true %}
        </div>
      </button>
          </div>
        <button class="lg:hidden opacity-75"
          aria-label="Close"
          _="
          on click
            toggle .invisible on #navigation-bar
            toggle .scale-x-0 on #navigation-bar
            toggle .scale-x-100 on #navigation-bar
            halt
          end
          "
        >
          {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: "x-mark" iconType: "solid" iconSize: 'small' roundedBorder: false, themeColor: true  %}
        </button>
      </div>
      <!-- Logo -->
      {% assign lightLogo = site.logoLightPath | pathExists %} 
      {% assign darkLogo = site.logoDarkPath | pathExists %} 
        <a href="/" class="flex  justify-end lg:block lg:-order-1">
          <div id="logoLight" class="">
            {% if lightLogo and lightLogo != "" %}
            <img  class="max-w-[150px]" src="{{ lightLogo }}" alt="logo for {{ site.name }}">
            {% else  %}
            <div class="cs-logoFont text-2xl hover:underline">{{ site.name }}</div>
            {% endif %}
          </div>
          <div id="logoDark" class="hidden">
            {% if darkLogo and darkLogo != "" %}
            <img class="max-w-[150px]" src="{{ darkLogo }}" alt="logo for {{ site.name }}">
            {% else  %}
            <div class="cs-logoFont text-2xl hover:underline">{{ site.name }}</div>
            {% endif %}
          </div>
        </a>

      {% if docCollections.size > 1 %}
    <!-- Collection Selection Section -->
    <div class="relative">
        <button
          id="collection-button"
          class="w-full pl-5 pr-10 py-2 bg-body border border-transparent focus:border-accent-secondary rounded-md focus:outline-none focus:ring-1 focus:ring-accent-secondary text-sm appearance-none cursor-pointer transition-colors duration-200 text-left"
          _="
            on click
            toggle .invisible on #collection-dropdown
            toggle .scale-y-0 on #collection-dropdown
            toggle .scale-y-100 on #collection-dropdown
            toggle .transform on #dropdown-arrow
            toggle .rotate-180 on #dropdown-arrow
              halt
            end
            on click from elsewhere
              add .scale-y-0 to #collection-dropdown
              add .invisible to #collection-dropdown 
              remove .scale-y-100 from #collection-dropdown
              remove .rotate-180 from #dropdown-arrow
            end
          "
        >
          <div class="flex items-center gap-2">
            <div class="opacity-60 ">
              {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: primaryCollection.icon iconType: "solid" iconSize: 'micro' roundedBorder: false, themeColor: true %}
            </div>
            <p>{{ primaryCollectionName | default: "Select a Collection" }}</p>
          </div>
          <div class="absolute inset-y-1 right-0 flex items-center pr-3 pointer-events-none">
            <svg id="dropdown-arrow" class="w-5 h-4 text-muted transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </button>

        <div
          id="collection-dropdown"
          class="absolute top-full left-1 mt-1 w-full bg-body border border-borderColor-primary rounded-md shadow-lg transition-all duration-300 origin-top invisible scale-y-0 max-h-[60vh] overflow-y-auto z-10"
        >

          {% for collection in docCollections %}
          {% if primaryCollectionTag == collection.key %}
            {% else %}
            
            <a href="{{ collection.path }}" class="py-2 text-sm text-textColor-primary hover:bg-interactive-hover flex items-center gap-2">

            <div class="opacity-60 pl-5">
              {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: collection.icon iconType: "solid" iconSize: 'micro' roundedBorder: false, themeColor: true %}
            </div>
              <p>{{ collection.name }}</p></a>
          {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

   
    <!-- Navigation List -->
    <nav class="overflow-y-auto flex-grow min-h-32">
      <ul class="flex flex-col gap-1">
        {% for entry in navPages %} {% render "partials/render-sidebar.html",
          entry: entry, level:-1, page:page, eleventyNavigation: eleventyNavigation, navPages: navPages %} {% endfor %}
      </ul>
      <div class="notification hidden bg-cyan-100 border border-cyan-700 p-4 mt-4">
          <div class="  text-left">
              <p class="text-2xl text-cyan-900">No Live Updates</p>
              <div class="text-base text-slate-900">
              <p class="text-base text-slate-900">This navigation bar and collection selector does not live update. Save your changes to see updated navigation</p>
              <p class="text-sm"><br> This note is only visible in live editor. It won't be shown in live site</p>
              </div>
          </div>
      </div>
    </nav>
      <!-- Theme Toggle -->
    <div class="hidden lg:flex justify-between">
      <button 
        id="dark-toggle"
        class="flex gap-2 p-2 items-center text-sm opacity-75 border border-textColor-primary rounded-full"
        aria-label="Toggle color theme"
      >
        <div id="sun-icon">
          {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: "sun" iconType: "solid" iconSize: 'micro' roundedBorder: false, themeColor: true %}
        </div>
        <div id="moon-icon">
          {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: "moon" iconType: "solid" iconSize: 'micro' roundedBorder: false, themeColor: true %}
        </div>
      </button>
    </div>
   
  </aside>

  {% comment %}Check if table of contents exists {% endcomment %}
  {% if bookshopTOC and bookshopTOC != ""  %}
    {% assign tocExists = true %}
  {% endif %}
  {% if contentTOC and contentTOC != "" %}
    {% assign tocExists = true %}
  {% endif %}

  <div class="order-2 flex flex-col flex-1 min-w-0">
    {% include "partials/banner.html" %}
    <!-- Mobile TOC Dropdown -->
    <div id="mobile-navbar" class="transition-all duration-300 {% if tocExists %}xl:hidden{% else  %}lg:hidden {% endif %} sticky top-0 z-10 w-full bg-body p-4 border-b border-borderColor-primary">
       <div class="lg:hidden flex gap-4 justify-end opacity-75 w-full bg-body ">
          <button
            aria-label="Search"
            _="
            on click
            set modal to #modal-search
            modal.show()
            transition #modal-search opacity to 1 over 0.2s
            "
            >
            {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: "magnifying-glass" iconType: "solid" iconSize: 'xsmall' roundedBorder: false, themeColor: true %}
          </button>
          <button
            aria-label="Toggle navigation"
            _="
            on click
              toggle .invisible on #navigation-bar
              toggle .scale-x-0 on #navigation-bar
              toggle .scale-x-100 on #navigation-bar
              halt
            end
            "
          >
            {% bookshop "generic/heroLibraryIcon" heroLibraryIconName: "bars-3-bottom-right" iconType: "solid" iconSize: 'xsmall' roundedBorder: false, themeColor: true %}
          </button>
    </div> 
    {% if tocExists %}
      
      <div class="mt-2 relative w-full">
        <button
          id="mobile-toc-button"
          class="flex items-center opacity-50 justify-between w-full px-4 py-3 bg-interactive-hover border border-transparent rounded-md text-textColor-primary font-medium focus:outline-none focus:ring-1 focus:ring-accent-secondary transition-colors duration-200"
          _="
            on click
            toggle .invisible on #mobile-toc-dropdown
            toggle .scale-y-0 on #mobile-toc-dropdown
            toggle .scale-y-100 on #mobile-toc-dropdown
            toggle .transform on #toc-dropdown-arrow
            toggle .rotate-180 on #toc-dropdown-arrow
              halt
            end
            on click from elsewhere
              add .scale-y-0 to #mobile-toc-dropdown
              add .invisible to #mobile-toc-dropdown 
              remove .scale-y-100 from #mobile-toc-dropdown
              remove .rotate-180 from #toc-dropdown-arrow
            end
          "
        >
          <span class="text-sm opacity-80">On This Page</span>
          <span id="toc-dropdown-arrow"  class="transition-transform duration-300">
            <svg  xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </span>
        </button>
        <div
          id="mobile-toc-dropdown"
          aria-expanded="false"
          class="absolute top-full left-1 mt-1 w-[calc(100%-8px)] bg-interactive-hover border border-borderColor-primary rounded-md shadow-lg transition-all duration-300 origin-top invisible scale-y-0 max-h-[60vh] overflow-y-auto z-10"
        >
          <div class="px-4 py-2 opacity-80 text-sm">
            {{ bookshopTOC }}
            {{ contentTOC }}
          </div>
        </div>
      </div>
    {% endif %}
    </div>
   
    <div class="flex-1 overflow-x-auto">
      <!-- Main Content Area -->
      <div 
      {% if primaryCollectionName or primaryCollectionTag=="changelog" %}
        data-pagefind-filter="collection:{{ primaryCollectionName | default: primaryCollectionTag }}" 
        {% endif %} 
        class=" flex w-full mx-auto p-8">
        <div class="cs-mainContent mt-16 xl:mt-0 flex flex-col w-full cs-mainContent max-w-4xl mx-auto flex-1">
          <div data-pagefind-body>
            <h1>{{ title }}</h1>
            {% bookshop_include "doc" editorial_blocks: editorial_blocks %}
            {% if content and content != "" %}
              <article data-cms-edit="content" class=" ">
                {{ content }}
              </article>
            {% endif %}
          </div>

          <!-- PREVIOUS/NEXT NAVIGATION RENDER -->
          <div class="mt-12 pt-8 border-t border-borderColor-primary flex justify-between items-start gap-4">
            {% if prev_url %}
              <a href="{{ prev_url }}" class="flex-1 text-left p-4 border border-borderColor-primary rounded-md hover:bg-interactive-hover transition-colors duration-200">
                <div class="text-sm text-muted flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
                  </svg>
                  Back
                </div>
                <div class="font-semibold text-textColor-primary mt-1">
                  {% if prev_parent and prev_parent != "" %}<span class="text-muted font-normal">{{ prev_parent }} / </span>{% endif %}{{ prev_title }}
                </div>
              </a>
            {% else %}
              <div class="flex-1"></div> {% comment %}  Empty div to keep the "Back" link on the left {% endcomment %}
            {% endif %}

            {% if next_url %}
              <a href="{{ next_url }}" class="flex-1 text-right p-4 border border-borderColor-primary rounded-md hover:bg-interactive-hover transition-colors duration-200">
                <div class="text-sm text-muted flex items-center justify-end gap-2">
                  Next
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8"/>
                  </svg>
                </div>
                <div class="font-semibold text-textColor-primary mt-1">
                  {% if next_parent and next_parent != "" %}<span class="text-muted font-normal">{{ next_parent }} / </span>{% endif %}{{ next_title }}
                </div>
              </a>
            {% else %}
              <div class="flex-1"></div> {% comment %}  Empty div to keep the "Back" link on the left  {% endcomment %}
            {% endif %}
          </div>

        </div>
      </div>
    </div>
  </div>
 
  <!-- Right Table of Contents (TOC) -->
   {% if tocExists %}
  <div class="order-3 hidden xl:block w-72 h-screen p-4 sticky top-0 overflow-y-auto">
    <div class="flex flex-col gap-4">
      <p class="text-sm font-semibold opacity-75">On this page</p>
      <div class="opacity-80 text-sm">
          {{ bookshopTOC }}
          {{ contentTOC }}
      </div>
      <div class="notification hidden bg-cyan-100 border border-cyan-700 p-4 mt-4">
          <div class="  text-left">
              <p class="text-2xl text-cyan-900">No Live Updates</p>
              <div class="text-base text-slate-900">
              <p class="text-base text-slate-900">This table of contents does not live update. Save your changes to see updated table of contents</p>
              <p class="text-sm"><br> This note is only visible in live editor. It won't be shown in live site</p>
              </div>
          </div>
      </div>
    </div>
  </div>
   {% endif %}
 
</div>
{% endblock %}
